# Steam 状态监控插件 (astrbot_plugin_steam_monitor)

一个简单但强大的 Steam 游戏状态与成就监控插件，适用于 AstrBot。

它能监控指定的 Steam 用户，当他们的**在线状态**、**游戏状态**或**游戏成就**发生变化时，向指定的群组或好友发送实时通知。

## ✨ 主要功能

- **状态与成就监控**:
    - **游戏状态**: 监控用户开始玩、退出游戏的状态。
    - **在线状态**: 监控用户上线、下线的状态（可配置开启/关闭）。
    - **成就进度**: 监控用户获得的新成就，并展示成就详情。
    - **游戏时长**: 监控用户在检测周期内的游戏时长变化（反隐身雷达）。
- **高度可定制化**:
    - **多会话支持**: 可以为不同的群聊或私聊设置不同的监控列表。
    - **独立通知开关**: 每个群聊/私聊都可以独立设置是否接收游戏状态、在线状态、成就动态的通知，覆盖全局设置。
    - **隐私模式**: 可以在指定群聊/私聊中隐藏被监控者的真实 Steam 昵称，用“有人”或自定义的代称来代替，保护隐私。
- **灵活的指令系统**:
    - 管理员和普通用户拥有不同权限。
    - 提供了丰富的指令来管理监控列表、查询状态。
- **内置测试模式**:
    - 无需真实的 Steam 账号，使用内置的测试指令即可模拟各种状态和成就变更，方便用户验证插件配置是否成功。
- **智能缓存**:
    - 缓存游戏名称、成就信息等，减少对 Steam API 的请求，提高响应速度。

## ⚙️ 配置说明

在开始使用前，你需要在 `_conf_schema.json` 对应的 AstrBot 插件配置界面填入以下信息：

| 配置项                             | 类型   | 描述                                                                                                                                                                                                                 |
| ---------------------------------- | ------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `steam_api_key`                    | 字符串 | **（必需）** 你的 Steam Web API 密钥。你可以在 [这里](https://steamcommunity.com/dev/apikey) 申请。                                                                                                                                |
| `admin_only_sensitive_operations`  | 布尔   | `true`/`false`。是否仅允许机器人管理员执行添加/移除/查询全部等敏感操作。默认为 `true`。                                                                                                                                         |
| `status_poll_interval`             | 整数   | 检查【在线/游戏状态】的间隔时间（秒）。默认为 `180` 秒。                                                                                                                                                                  |
| `achievement_poll_interval`        | 整数   | 检查【成就状态】的间隔时间（秒）。默认为 `1800` 秒。设为 `0` 可关闭成就监控。                                                                                                                                                                     |
| `status_notification`              | 布尔   | **全局总开关**：是否开启游戏和在线/离线状态的通知。                                                                                                                                                                             |
| `online_offline_notification`      | 布尔   | 是否在用户上线/下线时发送通知。这依赖于 `status_notification` 开启。                                                                                                                                                       |
| `achievements_notification`        | 布尔   | **全局总开关**：是否开启新成就的通知。                                                                                                                                                                                      |
| `playtime_notification`            | 布尔   | **全局总开关**：是否开启游戏时长变化的通知（默认开启）。                                                                                                                                                                        |
| `private_mode`                     | 布尔   | **全局总开关**：是否在所有通知中隐藏 Steam 昵称。                                                                                                                                                                         |
| `private_name`                     | 字符串 | 当 `private_mode` 开启时，用来替换 Steam 昵称的自定义代称。如果留空，默认为“有人”。例如：`张三 上线了` -> `有人 上线了`。                                                                                                                                    |
| `monitored_targets`                | 文本   | **（核心配置）** 一个 JSON 格式的文本，用于定义监控目标。**请看下方的详细解释**。                                                                                                                                        |

### `monitored_targets` 详解

这是插件的核心配置，它告诉插件“在哪个聊天里监控哪些人，并应用何种规则”。

其基本结构是一个 JSON 对象，`键` 是 **会话 ID** (`unified_msg_origin`)，`值` 是该会话的配置。

**会话 ID** 的格式示例：
- **QQ群**: `napcat:GroupMessage:12345678` (将 `12345678` 替换为你的群号)
- **QQ私聊**: `napcat:FriendMessage:10001` (将 `10001` 替换为你的 QQ 号)

每个会话的配置包括两部分：
1.  `steam_ids`: 一个包含17位 Steam ID 的列表。
2.  `settings`: （可选）一个用于**覆盖全局设置**的对象。如果为 `null` 或不填，则该会话完全遵循全局设置。

#### `settings` 可覆盖项

- `status_notification` (布尔)
- `online_offline_notification` (布尔)
- `achievements_notification` (布尔)
- `playtime_notification` (布尔)
- `private_mode` (布尔)

#### 配置示例

```json
{
  // 在群 12345678 中监控两个用户，使用全局通知设定
  "napcat:GroupMessage:12345678": {
    "steam_ids": [
      "76561198872155923",
      "76561198162682439"
    ],
    "settings": null
  },
  // 在群 87654321 中监控两个用户，并覆盖设置：关闭状态通知，只开启成就通知
  "napcat:GroupMessage:87654321": {
    "steam_ids": [
      "76561198082578593",
      "76561198329268343"
    ],
    "settings": {
      "status_notification": false,
      "achievements_notification": true,
      "playtime_notification": true
    }
  },
  // 在与 QQ 用户 10001 的私聊中监控一个用户，并开启所有状态通知和隐私模式
  "napcat:FriendMessage:10001": {
    "steam_ids": [
      "76561197960287930"
    ],
    "settings": {
      "status_notification": true,
      "online_offline_notification": true,
      "achievements_notification": false,
      "private_mode": true
    }
  }
}
```

## 📝 命令列表

**注意**:
- `<steam_id>` 代表一个17位的纯数字 Steam ID。
- 标记为 `(管理员)` 的命令需要机器人的管理员权限（取决于 `admin_only_sensitive_operations` 配置）。

---

### 查询指令

- **`steam list`**
  - **功能**: 获取**当前会话**监控的所有玩家的实时游戏状态。
  - **权限**: 所有人

- **`steam alllist`** `(管理员)`
  - **功能**: 获取**所有会话**监控的所有玩家的游戏状态，并按会话分组显示。
  - **权限**: 管理员

---

### 管理指令

- **`steam add <steam_id>`** `(管理员)`
  - **功能**: 在**当前会话**的监控列表中添加一个 Steam 用户。
  - **示例**: `steam add 76561198872155923`
  - **权限**: 管理员

- **`steam remove <steam_id>`** `(管理员)`
  - **功能**: 从**当前会话**的监控列表中移除一个 Steam 用户。
  - **示例**: `steam remove 76561198872155923`
  - **权限**: 管理员

---

### 测试指令

这些指令会自动将一个虚拟的“测试用户”加入当前会话的监控列表，并模拟一次状态变更。你可以用它们来检查插件是否配置正确、通知是否能正常发出。

- **`steam test status`**
  - **功能**: 模拟一次“测试用户”**退出游戏**（从“游戏中”变为“在线”）的状态变更。
  - **预期结果**: 在下一个状态检查周期，机器人会发出一条“退出了游戏”的通知。

- **`steam test offline`**
  - **功能**: 模拟一次“测试用户”**从游戏中直接下线**的状态变更。
  - **预期结果**: 在下一个状态检查周期，机器人会根据你的会话配置，发出“下线了”或“退出了游戏”的通知。

- **`steam test achievements`**
  - **功能**: 模拟一次“测试用户”在《赛博朋克 2077》中获得一个**新成就**。
  - **预期结果**: 在下一个成就检查周期，机器人会发出一条获得新成就的通知。如果测试用户已“全成就”，会自动重置其成就列表以便再次测试。

---